<!--
{% comment %}
Licensed to the Apache Software Foundation (ASF) under one or more
contributor license agreements.  See the NOTICE file distributed with
this work for additional information regarding copyright ownership.
The ASF licenses this file to you under the Apache License, Version 2.0
(the "License"); you may not use this file except in compliance with
the License.  You may obtain a copy of the License at

http://www.apache.org/licenses/LICENSE-2.0

Unless required by applicable law or agreed to in writing, software
distributed under the License is distributed on an "AS IS" BASIS,
WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
See the License for the specific language governing permissions and
limitations under the License.
{% endcomment %}
-->

# Implementing Diamond Hardened Joins in Apache Calcite

## Architecture
![L E Arch](https://github.com/user-attachments/assets/48fc92d9-9599-480b-aea9-8ac5eca11a17)

The code for Python Query Execution Engine can be found here: https://github.com/VimukthiPahasaraGodage/diamond-hardened-joins-implementation-benchmark

## Usage

1. Build and run the DatabaseEngine.java in org.example.diamondhardenedjoins package.
 - To run, you need to have the dataset in the path ```C:\Benchmark2_Dataset``` or you can extract the dataset to anywhere and note the path to the folder where the dataset is extracted to.
 - Dataset used for the demo can be accessed here: https://github.com/VimukthiPahasaraGodage/diamond-hardened-joins-implementation-benchmark
 - Please note that if you are changing the dataset, please change the DatabaseLoader.java and SchemaBuilder.java to match your dataset. We will replace those classes with auto schema builder in near future!

2. After loading the in-memory database and building the schema, you will get a prompt as
   ``` sql> ```

    - Command format:
        - ```\s <query> [--std-out 0|1] [--omit-exec 0|1] [--out file] [--opt 'LE-decomposition'| 'normal'] [--execution-tree-visualizations-folder path] [--generated-codes-folder path] [--logs-folder path] [--calcite-outputs-folder path] [--backend-exe-path path] [--csv-dataset-path path] [--visualize 0|1] [--std-code-out 0|1]```
        - ```\f <sql file path> [--std-out 0|1] [--omit-exec 0|1] [--out file] [--opt 'LE-decomposition'| 'normal'] [--execution-tree-visualizations-folder path] [--generated-codes-folder path] [--logs-folder path] [--calcite-outputs-folder path] [--backend-exe-path path] [--csv-dataset-path path] [--visualize 0|1] [--std-code-out 0|1]```
            - --std-out: whether to display output in console
            - --omit-exec: whether to omit the in-built execution engine in Apache Calcite for physical plan evaluation
            - --out: output file name of the sql query processing results(if not provided, a default name will be generated)
            - --opt: whether to apply LE-decomposition to the optimized plan we get from Apache Calcite
            - --execution-tree-visualizations-folder: path to save the visualizations generated by GraphViz for query plans
            - --generated-codes-folder-path: path to save the query execution code generated for each query
            - --logs-folder: path to save the execution log and the metrics of execution(time, memory and intermediate size)
            - --calcite-outputs-folder-path: path to save the outputs from Apache Calcite pipeline(Sql Query, Validation, Logical Plan and Physical Plan)
            - --backend-exe-path: Python query execution engine file path(follow the instructions in repo: https://github.com/VimukthiPahasaraGodage/diamond-hardened-joins-implementation-execution-backend)
            - --csv-dataset-path: path to the dataset
            - --visualize: whether to generate visualizations or not
            - --std-code-out: whether to print the generated code for query execution to be printed on std out


Slides: https://docs.google.com/presentation/d/10pQQf5v7U1kIp9n6DDeKisQg3cd0Pa4Ykq88JuKS9hw/edit?usp=sharing

Apache Calcite: https://github.com/apache/calcite

Benchmark Dataset: https://github.com/VimukthiPahasaraGodage/diamond-hardened-joins-implementation-benchmark
